<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <title>Мои инвестиции</title>
    <link th:href="@{/css/style.css}" rel="stylesheet"/>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" th:src="@{/js/chart.js}"></script>
    <script type="text/javascript" th:inline="javascript">
        const result = [[${result}]]
        for (const instrumentData of result["history"]) {
            const headers = ['Дата', instrumentData["instrument"]["name"], {'type': 'string', 'role': 'style'}]
            const candles = instrumentData["visualizationCandles"].map(
                candle => [new Date(candle["ts"]), candle["closePrice"],
                    (candle["wasBought"] ?
                        'point { size: 4; fill-color: #109c00; visible: true; }' :
                        candle["wasSold"] ?
                            'point { size: 4; fill-color: #9c001a; visible: true; }' :
                            null)])
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            function drawChart() {
                const data = google.visualization.arrayToDataTable([
                    headers,
                    candles[0]
                ]);

                const options = {
                    title: 'Динамика компании',
                    hAxis: {title: 'Year', titleTextStyle: {color: '#333'}},
                    vAxis: {minValue: 0},
                };

                const chart = new google.visualization.AreaChart(document.getElementById('chart-' + instrumentData["instrument"]["figi"]));
                const chank = 20

                async function draw() {
                    let v = 1
                    for (; v + chank < candles.length; v += chank) {
                        data.addRows(candles.slice(v, v + chank))
                        chart.draw(data, options)
                        await new Promise(r => setTimeout(r, 0.01))
                    }
                    if (v !== candles.length - 1) {
                        data.addRows(candles.slice(v, candles.length))
                        chart.draw(data, options)
                    }
                }

                draw()
            }
        }
    </script>
</head>
<body>
<th:block th:each="instrument : ${result.history()}">
    <div th:id="${'chart-' + instrument.instrument().figi()}" style="width: 100%; height: 500px;"></div>
</th:block>
</body>
